---
# lensing-t8fv
title: Create marketplace client with index fetch and cache
status: completed
type: task
priority: high
created_at: 2026-02-28T15:46:35Z
updated_at: 2026-03-01T01:23:20Z
parent: lensing-7nct
---

Core service that fetches and caches the marketplace index.json from GitHub.

## Acceptance Criteria

- [x] Fetches index.json from raw.githubusercontent.com/<org>/<repo>/main/index.json
- [x] Caches locally on disk (pluginsDir/.marketplace-cache/index.json)
- [x] 15-minute refresh interval (configurable)
- [x] Returns cached data if GitHub is unreachable
- [x] Validates index.json schema (version field, plugins array)
- [x] Falls back to last known good cache if fetch returns malformed data
- [x] Marketplace repo URL configurable in settings

---

**Size:** M
**Area:** backend

## Summary

**Files created:**

- packages/core/src/marketplace-client.ts (86 lines) — createMarketplaceClient() factory
- packages/core/src/**tests**/marketplace-client.test.ts (220 lines) — 9 tests

**Files modified:**

- packages/types/src/index.ts — added MarketplaceIndex interface
- packages/core/src/index.ts — exported createMarketplaceClient, MarketplaceClientOptions, MarketplaceClientInstance, MarketplaceIndex

**Key decisions:**

- refreshInterval is in milliseconds (default 900_000 = 15 min)
- Three-tier fallback: in-memory cache → GitHub fetch → disk cache
- Schema validation requires version:string and plugins:Array (minimal per spec)
- lastFetchTime NOT updated on failed fetch — next call will retry GitHub
- isValidIndex validates structure but not individual plugin entries (per spec)

**Notes for next task:**

- Use createMarketplaceClient({ cacheDir, marketplaceRepo, refreshInterval? })
- getIndex() returns Promise<MarketplaceIndex> — may throw if no cache and GitHub unreachable
- The 'offline' flag (used by REST handler) must be determined by the caller (not exposed by client)
- MarketplaceIndex.plugins are typed as MarketplacePlugin[] from @lensing/types

---

_Auto-generated by PASIV_
