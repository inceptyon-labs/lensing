---
# lensing-914x
title: Implement PIR sensor GPIO integration
status: completed
type: task
priority: normal
tags:
    - pasiv
    - size:M
    - area:backend
    - area:infra
created_at: 2026-02-16T21:24:53Z
updated_at: 2026-02-23T22:19:09Z
parent: lensing-jnf0
---

PIR sensor reading via GPIO for presence-based display control.

## Acceptance Criteria

- [x] GPIO pin reading for PIR sensor on Raspberry Pi (onoff or pigpio)
- [x] Motion detected → wake display from ambient, switch to active scene
- [x] No motion for N minutes (configurable) → dim to ambient mode
- [x] Graceful fallback: feature disabled when no PIR sensor detected
- [x] Presence state exposed via data bus and admin panel

---

**Size:** M

## Completed

**Files changed:**
- packages/types/src/pir-sensor.ts (new) — PresenceData, GpioWatcher, PIRServerOptions types
- packages/types/src/index.ts — export PIR types
- packages/core/src/pir-server.ts (new) — createPIRServer factory
- packages/core/src/index.ts — export createPIRServer
- packages/core/src/plugins/pir-sensor/plugin.json (new) — plugin manifest
- packages/core/src/__tests__/pir-server.test.ts (new) — 24 unit tests
- packages/core/src/__tests__/pir-integration.test.ts (new) — 4 integration tests
- packages/ui/src/presence-store.ts (new) — createPresenceStore factory
- packages/ui/src/index.ts — export createPresenceStore
- packages/ui/src/__tests__/presence-store.test.ts (new) — 11 store tests

**Key decisions:**
- Injectable GpioWatcherFactory for testability (like fetchFn/wsFn pattern)
- Idle timeout via configurable timer (default 5 min) — GPIO LOW does not immediately clear
- Startup error replay: stored and replayed to each onError listener
- Data bus channel: presence.pir
- Guarded dataBus.publish and watcher.close against throws (Codex review)
- Partial-init cleanup: watcher closed if watch() fails after creation

**Notes for next task:**
- createPIRServer exports from @lensing/core
- createPresenceStore exports from @lensing/ui
- Data bus channel: presence.pir (subscribe for presence events)
- Consumer wiring: server.onUpdate → store.setData
- Scene switching: subscribe to presence.pir, call sceneManager.switchTo() on state change
- 589 tests passing total

---
*Auto-generated by PASIV*
